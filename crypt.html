<!DOCTYPE html>
<html>
<head>
    <title>Secure XIAO Mote</title>
    <script src="https://unpkg.com/@noble/curves@1.2.0/dist/index.js"></script>
    <style>
        body { background: #111; color: #eee; font-family: sans-serif; text-align: center; padding-top: 50px; }
        #trackpad { width: 300px; height: 300px; background: #222; border: 2px solid #444; margin: 20px auto; border-radius: 10px; }
        .active { border-color: #007bff !important; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; }
    </style>
</head>
<body>
    <h2 id="status">Disconnected</h2>
    <button id="connectBtn">Connect & Secure</button>
    <div id="trackpad">Trackpad Area</div>

    <script>
        const DEVICE_PUB_HEX = "719e7e8354c0428d055a4087e502579df6e10f19f2a033f2187c9451458d927a";
        let hidChar, sharedKey;

        document.getElementById('connectBtn').onclick = async () => {
            try {
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ name: 'XIAO-Vault' }],
                    optionalServices: ["6e400001-b5a3-f393-e0a9-e50e24dcca9e"]
                });
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService("6e400001-b5a3-f393-e0a9-e50e24dcca9e");
                hidChar = await service.getCharacteristic("6e400002-b5a3-f393-e0a9-e50e24dcca9e");

                // --- Handshake ---
                const x25519 = nobleCurves.ed25519; // noble library access
                const appPriv = x25519.utils.randomPrivateKey();
                const appPub = x25519.getPublicKey(appPriv);
                
                await hidChar.writeValue(appPub); // Send 32 bytes
                sharedKey = x25519.getSharedSecret(appPriv, DEVICE_PUB_HEX);
                
                document.getElementById('status').innerText = "SECURE TUNNEL ACTIVE";
            } catch (e) { alert(e); }
        };

        async function sendMove(x, y) {
            if (!sharedKey) return;
            const iv = crypto.getRandomValues(new Uint8Array(16));
            const payload = new Uint8Array([109, x, y]);
            const packet = new Uint8Array(16 + payload.length);
            packet.set(iv);
            for(let i=0; i<payload.length; i++) {
                packet[i+16] = payload[i] ^ sharedKey[i%32] ^ iv[i%16];
            }
            await hidChar.writeValueWithoutResponse(packet);
        }

        const trackpad = document.getElementById('trackpad');
        trackpad.onmousemove = (e) => {
            if (e.buttons === 1) sendMove(e.movementX, e.movementY);
        };
    </script>
</body>
</html>
