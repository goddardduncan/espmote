<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>XIAO Remote Secure</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
      :root {
        --google-blue: #4285f4;
        --bg-gray: #f8f9fa;
        --text-dark: #3c4043;
        --card-bg: #ffffff;
      }
      body {
        background-color: var(--bg-gray);
        font-family: "Segoe UI", system-ui, sans-serif;
        margin: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100vh;
        color: var(--text-dark);
        overflow: hidden;
        touch-action: none;
      }

      .header {
        position: absolute;
        top: 3%;
        text-align: center;
      }
      #status {
        font-size: 13px;
        color: #5f6368;
        margin-top: 4px;
      }

      #trackpad-card {
        background: var(--card-bg);
        width: 85vw;
        max-width: 450px;
        height: 42vh;
        border-radius: 28px;
        border: 1px solid #dadce0;
        box-shadow: 0 1px 3px rgba(60, 64, 67, 0.3);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        cursor: crosshair;
        transition: all 0.3s ease;
        position: relative;
      }
      #trackpad-card.active {
        border: 2px solid var(--google-blue);
        box-shadow: 0 8px 24px rgba(66, 133, 244, 0.15);
        transform: scale(1.01);
      }

      .btn {
        background: var(--google-blue);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 24px;
        font-weight: 500;
        cursor: pointer;
        transition: 0.2s;
        margin: 5px;
      }
      .btn-ota {
        background: #34a853;
        width: 100%;
        margin-top: 10px;
      }
      .btn-ota:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      
      #confirmBtn {
        background: #34a853;
        display: none; 
      }
      #updateKeyBtn {
        background: var(--google-blue);
        display: none;
      }

      .key-container {
        display: flex;
        align-items: center;
        background: white;
        border: 1px solid #dadce0;
        border-radius: 12px;
        padding: 2px 10px;
        margin-bottom: 10px;
        width: 85vw;
        max-width: 450px;
        box-sizing: border-box;
      }
      #aesKey {
        border: none;
        padding: 8px;
        outline: none;
        text-align: center;
        font-family: monospace;
        flex-grow: 1;
        font-size: 14px;
        background: transparent;
        min-width: 0; 
      }
      .toggle-pass {
        cursor: pointer;
        font-size: 18px;
        user-select: none;
        padding: 5px;
      }

      .shortcut-hint {
        position: absolute;
        bottom: 20px;
        font-size: 12px;
        color: #70757a;
        background: #f1f3f4;
        padding: 6px 14px;
        border-radius: 20px;
        display: flex;
        align-items: center;
        gap: 6px;
        opacity: 0;
        pointer-events: none;
      }
      #trackpad-card.active .shortcut-hint {
        opacity: 1;
      }
      .key-cap {
        background: #fff;
        border: 1px solid #bdc1c6;
        border-bottom-width: 3px;
        padding: 2px 6px;
        border-radius: 4px;
        font-weight: bold;
        font-family: monospace;
      }

      #ota-panel {
        margin-top: 15px;
        width: 85vw;
        max-width: 450px;
        text-align: center;
        display: none;
      }
      .ota-toggle, .reset-link {
        color: #5f6368;
        font-size: 12px;
        cursor: pointer;
        text-decoration: underline;
        margin-bottom: 10px;
        display: block;
      }
      #ota-controls {
        display: none;
        background: #fff;
        padding: 15px;
        border-radius: 16px;
        border: 1px solid #dadce0;
        flex-direction: column;
        gap: 8px;
      }

      #fileList {
        max-height: 120px;
        overflow-y: auto;
        margin-bottom: 10px;
        border: 1px solid #eee;
        border-radius: 8px;
      }
      .file-item {
        text-align: left;
        font-size: 13px;
        padding: 12px;
        cursor: pointer;
        background: #f8f9fa;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
      }
      .file-item.selected {
        background: #e8f0fe;
        font-weight: bold;
        color: var(--google-blue);
        border-left: 4px solid var(--google-blue);
      }

      .progress-bar {
        width: 100%;
        height: 6px;
        background: #e8eaed;
        border-radius: 3px;
        overflow: hidden;
        margin: 10px 0;
        display: none;
      }
      .progress-fill {
        height: 100%;
        background: var(--google-blue);
        width: 0%;
        transition: width 0.1s;
      }
      .footer {
        position: absolute;
        bottom: 15px;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h2 style="margin: 0">XIAO Remote</h2>
      <div id="status">Ready to connect</div>
    </div>

    <div class="key-container" id="keyWrapper">
        <input type="password" id="aesKey" placeholder="16-character USB Passkey" maxlength="16" />
        <span class="toggle-pass" onclick="togglePassword()">üëÅÔ∏è</span>
    </div>

    <button id="updateKeyBtn" class="btn">Update Key</button>
    <button id="confirmBtn" class="btn">Confirm controls are active</button>
    <button id="connectBtn" class="btn">Connect Bluetooth</button>

    <div id="trackpad-card">
      <div id="instr">Tap to control device</div>
      <div class="shortcut-hint">
        Tap <span class="key-cap">`</span> 3x for
        <span class="key-cap">ESC</span>
      </div>
    </div>

    <div id="ota-panel">
      <span class="ota-toggle" onclick="toggleOTA()">Developer: Update Firmware</span>
      <div id="ota-controls">
        <div id="fileList">Loading GitHub firmware...</div>
        <div class="progress-bar" id="pBar">
          <div class="progress-fill" id="pFill"></div>
        </div>
        <button id="updateBtn" class="btn btn-ota" disabled>Flash Selected Build</button>
        <div id="otaStatus" style="font-size: 11px; color: #5f6368; margin-top: 5px">Select version</div>
      </div>
    </div>

    <div class="footer">
        <span class="reset-link" onclick="resetApp()">Reset PassKey</span>
    </div>

    <script>
      const REPO_API_URL = "https://api.github.com/repos/goddardduncan/espmote/contents/firmware";
      const dbName = "XiaoSecureDB";
      const storeName = "KeyStore";
      
      let mouseChar, keyChar, otaChar, aesKeyParsed, selectedFileArray = null;
      let hasAttemptedConnection = false;
      let hasActivatedOnce = false; // Tracks if the user has clicked the trackpad

      const UUIDS = {
        SERVICE: "6e400001-b5a3-f393-e0a9-e50e24dcca9e",
        MOUSE: "6e400002-b5a3-f393-e0a9-e50e24dcca9e",
        KEY: "6e400003-b5a3-f393-e0a9-e50e24dcca9e",
        OTA: "6e400004-b5a3-f393-e0a9-e50e24dcca9e",
      };

      // --- UI TOGGLES ---
      function togglePassword() { const i = document.getElementById("aesKey"); i.type = i.type === "password" ? "text" : "password"; }
      
      // INPUT MONITOR: If typing occurs, hide Confirm and show Update
      document.getElementById("aesKey").addEventListener("input", () => {
        if (hasAttemptedConnection) {
          document.getElementById("confirmBtn").style.display = "none";
          document.getElementById("updateKeyBtn").style.display = "block";
        }
      });

      // UPDATE KEY: Applies the new key to current session
      document.getElementById("updateKeyBtn").onclick = () => {
        const k = document.getElementById("aesKey").value;
        if (k.length !== 16) return alert("Key must be 16 chars");
        aesKeyParsed = CryptoJS.enc.Utf8.parse(k);
        document.getElementById("updateKeyBtn").style.display = "none";
        // Only show confirm if they have already tried using the trackpad
        if (hasActivatedOnce) {
            document.getElementById("confirmBtn").style.display = "block";
        }
      };

      async function openDB() { return new Promise((r) => { let q = indexedDB.open(dbName, 1); q.onupgradeneeded = () => q.result.createObjectStore(storeName); q.onsuccess = () => r(q.result); }); }
      async function saveKeyToDB(k) { const db = await openDB(); db.transaction(storeName, "readwrite").objectStore(storeName).put(k, "user_aes_key"); }
      async function getKeyFromDB() { const db = await openDB(); return new Promise((r) => { const req = db.transaction(storeName).objectStore(storeName).get("user_aes_key"); req.onsuccess = () => r(req.result); }); }
      function resetApp() { indexedDB.deleteDatabase(dbName); location.reload(); }

      window.onload = async () => {
        const k = await getKeyFromDB();
        if (k) { document.getElementById("aesKey").value = k; document.getElementById("keyWrapper").style.display = "none"; }
      };

      // --- ENCRYPTION & BLE ---
      async function sendEncrypted(characteristic, dataArray) {
        if (!characteristic || !aesKeyParsed) return;
        const randomIV = CryptoJS.lib.WordArray.random(16);
        const wordArray = CryptoJS.lib.WordArray.create(dataArray);
        const encrypted = CryptoJS.AES.encrypt(wordArray, aesKeyParsed, {
          iv: randomIV,
          mode: CryptoJS.mode.CBC,
          padding: CryptoJS.pad.Pkcs7,
        });
        const ivBytes = Uint8Array.from(atob(randomIV.toString(CryptoJS.enc.Base64)), (c) => c.charCodeAt(0));
        const cipherBytes = Uint8Array.from(atob(encrypted.toString()), (c) => c.charCodeAt(0));
        const combined = new Uint8Array(ivBytes.length + cipherBytes.length);
        combined.set(ivBytes);
        combined.set(cipherBytes, ivBytes.length);
        try { await characteristic.writeValueWithoutResponse(combined); } catch (e) {}
      }

      document.getElementById("connectBtn").onclick = async () => {
        const kVal = document.getElementById("aesKey").value;
        if (kVal.length !== 16) return alert("Key must be 16 chars");
        aesKeyParsed = CryptoJS.enc.Utf8.parse(kVal);

        try {
          const device = await navigator.bluetooth.requestDevice({
            filters: [{ namePrefix: "XIAO-" }],
            optionalServices: [UUIDS.SERVICE],
          });
          const server = await device.gatt.connect();
          const service = await server.getPrimaryService(UUIDS.SERVICE);
          mouseChar = await service.getCharacteristic(UUIDS.MOUSE);
          keyChar = await service.getCharacteristic(UUIDS.KEY);
          otaChar = await service.getCharacteristic(UUIDS.OTA);

          document.getElementById("status").innerText = "Connected";
          document.getElementById("connectBtn").style.display = "none";
          document.getElementById("ota-panel").style.display = "block";
          hasAttemptedConnection = true;

          loadGitHubFiles();
          device.addEventListener("gattserverdisconnected", () => { location.reload(); });
        } catch (e) {
          document.getElementById("status").innerText = e.message;
        }
      };

      document.getElementById("confirmBtn").onclick = async () => {
        const kVal = document.getElementById("aesKey").value;
        await saveKeyToDB(kVal);
        document.getElementById("keyWrapper").style.display = "none";
        document.getElementById("confirmBtn").style.display = "none";
        alert("Key saved to secure browser storage.");
      };

      // --- TRACKPAD & MOUSE ---
      const card = document.getElementById("trackpad-card");
      card.onclick = () => { 
        if (mouseChar) {
            card.requestPointerLock();
            hasActivatedOnce = true; // User has interacted with the controls
        }
      };
      
      document.addEventListener("pointerlockchange", () => {
        const locked = document.pointerLockElement === card;
        card.classList.toggle("active", locked);
        document.getElementById("instr").innerText = locked ? "Mode: Active" : "Tap to control device";
        
        // Return visibility logic: Show Confirm only after user has clicked trackpad
        if (hasAttemptedConnection && hasActivatedOnce && document.getElementById("keyWrapper").style.display !== "none") {
            // Only show Confirm if we aren't mid-edit (Update key is not visible)
            if (document.getElementById("updateKeyBtn").style.display === "none") {
                document.getElementById("confirmBtn").style.display = "block";
            }
        }
      });
      document.addEventListener("mousemove", (e) => {
        if (document.pointerLockElement === card) {
          const sensitivity = 1.5;
          const scaledX = Math.round(e.movementX * sensitivity);
          const scaledY = Math.round(e.movementY * sensitivity);    
          sendEncrypted(mouseChar, new Int8Array([109, scaledX, scaledY]));
        }
      });
      document.addEventListener("mousedown", (e) => {
        if (document.pointerLockElement === card)
          sendEncrypted(mouseChar, new Uint8Array([99, [1, 4, 2][e.button], 1]));
      });
      document.addEventListener("mouseup", (e) => {
        if (document.pointerLockElement === card)
          sendEncrypted(mouseChar, new Uint8Array([99, [1, 4, 2][e.button], 0]));
      });
      document.addEventListener("wheel", (e) => {
        if (document.pointerLockElement === card)
          sendEncrypted(mouseChar, new Int8Array([115, e.deltaY > 0 ? -1 : 1]));
      }, { passive: false });

      // --- KEYBOARD LOGIC ---
      let tickCount = 0, tickTime;
      document.addEventListener("keydown", (e) => {
        if (document.pointerLockElement === card && keyChar) {
          if (e.key === "Escape") return;
          e.preventDefault();

          if (e.key === "`") {
            tickCount++; clearTimeout(tickTime);
            if (tickCount === 3) {
              sendEncrypted(keyChar, new Uint8Array([107, 27, 1]));
              tickCount = 0;
            } else {
              tickTime = setTimeout(() => {
                if (tickCount === 1) sendEncrypted(keyChar, new Uint8Array([107, 96, 0]));
                tickCount = 0;
              }, 500);
            }
            return;
          }

          if ((e.ctrlKey || e.metaKey) && e.key.length === 1) {
            let mode = e.metaKey ? 4 : 3; 
            sendEncrypted(keyChar, new Uint8Array([107, 128, mode, e.key.toLowerCase().charCodeAt(0)]));
            return;
          }

          let val, mode = 0;
          const nav = { Backspace: 8, Tab: 9, Enter: 13, ArrowLeft: 37, ArrowUp: 38, ArrowRight: 39, ArrowDown: 40, Delete: 46 };
          if (nav[e.key]) { val = nav[e.key]; mode = 1; } 
          else if (e.key.length === 1) { val = e.key.charCodeAt(0); mode = 0; }
          if (val !== undefined) sendEncrypted(keyChar, new Uint8Array([107, val, mode]));
        }
      });

      // --- OTA ---
      async function loadGitHubFiles() {
        try {
          const response = await fetch(REPO_API_URL);
          const files = await response.json();
          const list = document.getElementById("fileList");
          list.innerHTML = "";
          files.filter((f) => f.name.endsWith(".bin")).forEach((file) => {
            const div = document.createElement("div");
            div.className = "file-item";
            div.innerHTML = `<span>üì¶ ${file.name}</span>`;
            div.onclick = async () => {
              document.getElementById("otaStatus").innerText = "Downloading...";
              const res = await fetch(file.download_url);
              selectedFileArray = new Uint8Array(await (await res.blob()).arrayBuffer());
              document.getElementById("otaStatus").innerText = "Ready: " + file.name;
              document.getElementById("updateBtn").disabled = false;
              Array.from(list.children).forEach((c) => c.classList.remove("selected"));
              div.classList.add("selected");
            };
            list.appendChild(div);
          });
        } catch (e) { document.getElementById("fileList").innerText = "Error loading GitHub."; }
      }

      function toggleOTA() {
        const c = document.getElementById("ota-controls");
        c.style.display = c.style.display === "flex" ? "none" : "flex";
      }

      document.getElementById("updateBtn").onclick = async () => {
        if (!selectedFileArray || !otaChar) return;
        document.getElementById("pBar").style.display = "block";
        const beginMsg = new Uint8Array(5);
        beginMsg[0] = 66; 
        new DataView(beginMsg.buffer).setUint32(1, selectedFileArray.length, true);
        await otaChar.writeValue(beginMsg);
        for (let i = 0; i < selectedFileArray.length; i += 128) {
          const chunk = selectedFileArray.slice(i, i + 128);
          const dataMsg = new Uint8Array(chunk.length + 1);
          dataMsg[0] = 68; dataMsg.set(chunk, 1);
          await otaChar.writeValue(dataMsg);
          let pct = Math.round((i / selectedFileArray.length) * 100);
          document.getElementById("pFill").style.width = pct + "%";
          document.getElementById("otaStatus").innerText = `Updating: ${pct}%`;
        }
        await otaChar.writeValue(new Uint8Array([69]));
        document.getElementById("otaStatus").innerText = "Success! Rebooting...";
      };
    </script>
  </body>
</html>
